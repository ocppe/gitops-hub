apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: detect-app-type
  namespace: ci-pipelines
spec:
  description: Detects the application type based on project files
  params:
    - name: source-dir
      description: Path to the source code
      type: string
      default: "source"
  workspaces:
    - name: source
  results:
    - name: app-type
      description: The detected application type (quarkus, angular, unknown)
    - name: app-name
      description: The application name from project files
    - name: app-version
      description: The application version from project files
  steps:
    - name: detect
      image: registry.access.redhat.com/ubi9/ubi-minimal:latest
      script: |
        #!/usr/bin/env bash
        set -e
        
        cd $(workspaces.source.path)/$(params.source-dir)
        
        APP_TYPE="unknown"
        APP_NAME="unknown"
        APP_VERSION="0.0.1"
        
        # Check for Quarkus (Maven)
        if [ -f "pom.xml" ]; then
          if grep -q "quarkus" pom.xml; then
            APP_TYPE="quarkus"
            APP_NAME=$(grep -m1 '<artifactId>' pom.xml | sed 's/.*<artifactId>\(.*\)<\/artifactId>.*/\1/' | head -1)
            APP_VERSION=$(grep -m1 '<version>' pom.xml | sed 's/.*<version>\(.*\)<\/version>.*/\1/' | head -1)
          else
            APP_TYPE="maven"
            APP_NAME=$(grep -m1 '<artifactId>' pom.xml | sed 's/.*<artifactId>\(.*\)<\/artifactId>.*/\1/' | head -1)
            APP_VERSION=$(grep -m1 '<version>' pom.xml | sed 's/.*<version>\(.*\)<\/version>.*/\1/' | head -1)
          fi
        fi
        
        # Check for Angular
        if [ -f "angular.json" ]; then
          APP_TYPE="angular"
          if [ -f "package.json" ]; then
            APP_NAME=$(grep -m1 '"name"' package.json | sed 's/.*"name": "\(.*\)".*/\1/')
            APP_VERSION=$(grep -m1 '"version"' package.json | sed 's/.*"version": "\(.*\)".*/\1/')
          fi
        fi
        
        # Check for Node.js (if not Angular)
        if [ -f "package.json" ] && [ "$APP_TYPE" = "unknown" ]; then
          APP_TYPE="nodejs"
          APP_NAME=$(grep -m1 '"name"' package.json | sed 's/.*"name": "\(.*\)".*/\1/')
          APP_VERSION=$(grep -m1 '"version"' package.json | sed 's/.*"version": "\(.*\)".*/\1/')
        fi
        
        echo "Detected app type: $APP_TYPE"
        echo "App name: $APP_NAME"
        echo "App version: $APP_VERSION"
        
        echo -n "$APP_TYPE" > $(results.app-type.path)
        echo -n "$APP_NAME" > $(results.app-name.path)
        echo -n "$APP_VERSION" > $(results.app-version.path)
