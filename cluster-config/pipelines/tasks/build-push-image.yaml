apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: build-push-image
  namespace: ci-pipelines
spec:
  description: Builds and pushes a container image using buildah
  params:
    - name: source-dir
      description: Path to the source code
      type: string
      default: "source"
    - name: dockerfile
      description: Path to the Dockerfile
      type: string
      default: "src/main/docker/Dockerfile.jvm"
    - name: image-registry
      description: Container registry
      type: string
      default: "quay.io"
    - name: image-repository
      description: Image repository
      type: string
      default: "ocppe"
    - name: image-name
      description: Image name
      type: string
    - name: image-tag
      description: Image tag
      type: string
      default: "latest"
  workspaces:
    - name: source
    - name: dockerconfig
      optional: true
  results:
    - name: image-url
      description: Full image URL
    - name: image-digest
      description: Image digest
  steps:
    - name: build-push
      image: registry.redhat.io/rhel8/buildah:latest
      workingDir: $(workspaces.source.path)/$(params.source-dir)
      securityContext:
        privileged: true
      env:
        - name: REGISTRY_AUTH_FILE
          value: /workspace/dockerconfig/.dockerconfigjson
      script: |
        #!/usr/bin/env bash
        set -e
        
        IMAGE_URL="$(params.image-registry)/$(params.image-repository)/$(params.image-name):$(params.image-tag)"
        IMAGE_URL_LATEST="$(params.image-registry)/$(params.image-repository)/$(params.image-name):latest"
        
        echo "Building image: $IMAGE_URL"
        
        # Check if Dockerfile exists
        if [ ! -f "$(params.dockerfile)" ]; then
          echo "Dockerfile not found at $(params.dockerfile), checking alternatives..."
          if [ -f "Dockerfile" ]; then
            DOCKERFILE="Dockerfile"
          elif [ -f "src/main/docker/Dockerfile.jvm" ]; then
            DOCKERFILE="src/main/docker/Dockerfile.jvm"
          else
            echo "No Dockerfile found!"
            exit 1
          fi
        else
          DOCKERFILE="$(params.dockerfile)"
        fi
        
        echo "Using Dockerfile: $DOCKERFILE"
        
        # Build the image
        buildah bud --storage-driver=vfs --format=oci \
          -f "$DOCKERFILE" \
          -t "$IMAGE_URL" \
          .
        
        # Tag as latest
        buildah tag --storage-driver=vfs "$IMAGE_URL" "$IMAGE_URL_LATEST"
        
        # Push images
        echo "Pushing image: $IMAGE_URL"
        buildah push --storage-driver=vfs \
          --authfile="${REGISTRY_AUTH_FILE}" \
          "$IMAGE_URL" \
          "docker://$IMAGE_URL"
        
        buildah push --storage-driver=vfs \
          --authfile="${REGISTRY_AUTH_FILE}" \
          "$IMAGE_URL_LATEST" \
          "docker://$IMAGE_URL_LATEST"
        
        # Get digest
        DIGEST=$(buildah inspect --storage-driver=vfs --format '{{.FromImageDigest}}' "$IMAGE_URL")
        
        echo "Image pushed successfully!"
        echo "URL: $IMAGE_URL"
        echo "Digest: $DIGEST"
        
        echo -n "$IMAGE_URL" > $(results.image-url.path)
        echo -n "$DIGEST" > $(results.image-digest.path)
